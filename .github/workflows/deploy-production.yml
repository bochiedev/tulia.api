name: Deploy to Production

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy-production:
    name: Deploy to Production Environment
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=tag
            type=sha,prefix=prod-
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.prod
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Create backup before deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          port: ${{ secrets.PRODUCTION_PORT }}
          script: |
            cd /opt/tulia-ai
            
            # Backup database
            docker-compose -f docker-compose.prod.yml exec -T db pg_dump -U ${{ secrets.PRODUCTION_DB_USER }} ${{ secrets.PRODUCTION_DB_NAME }} > backups/backup_$(date +%Y%m%d_%H%M%S).sql
            
            # Keep only last 7 backups
            cd backups && ls -t | tail -n +8 | xargs -r rm
      
      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          port: ${{ secrets.PRODUCTION_PORT }}
          script: |
            cd /opt/tulia-ai
            
            # Pull latest image
            docker pull ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:prod-${{ github.sha }}
            
            # Update environment variables from secrets
            cat > .env << EOF
            # Django Settings
            SECRET_KEY=${{ secrets.PRODUCTION_SECRET_KEY }}
            DEBUG=False
            ALLOWED_HOSTS=${{ secrets.PRODUCTION_ALLOWED_HOSTS }}
            
            # Database
            DATABASE_URL=${{ secrets.PRODUCTION_DATABASE_URL }}
            DB_CONN_MAX_AGE=600
            
            # Redis
            REDIS_URL=${{ secrets.PRODUCTION_REDIS_URL }}
            CELERY_BROKER_URL=${{ secrets.PRODUCTION_CELERY_BROKER_URL }}
            CELERY_RESULT_BACKEND=${{ secrets.PRODUCTION_CELERY_RESULT_BACKEND }}
            
            # JWT Authentication
            JWT_SECRET_KEY=${{ secrets.PRODUCTION_JWT_SECRET_KEY }}
            JWT_ALGORITHM=HS256
            JWT_EXPIRATION_HOURS=24
            JWT_REFRESH_EXPIRATION_DAYS=7
            
            # Encryption
            ENCRYPTION_KEY=${{ secrets.PRODUCTION_ENCRYPTION_KEY }}
            
            # OpenAI
            OPENAI_API_KEY=${{ secrets.PRODUCTION_OPENAI_API_KEY }}
            OPENAI_MODEL=gpt-4o-mini
            
            # Sentry
            SENTRY_DSN=${{ secrets.PRODUCTION_SENTRY_DSN }}
            SENTRY_ENVIRONMENT=production
            SENTRY_RELEASE=${{ github.sha }}
            
            # Rate Limiting
            RATE_LIMIT_ENABLED=True
            
            # Logging
            LOG_LEVEL=WARNING
            JSON_LOGS=True
            
            # Email
            EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
            EMAIL_HOST=${{ secrets.PRODUCTION_EMAIL_HOST }}
            EMAIL_PORT=${{ secrets.PRODUCTION_EMAIL_PORT }}
            EMAIL_USE_TLS=True
            EMAIL_HOST_USER=${{ secrets.PRODUCTION_EMAIL_HOST_USER }}
            EMAIL_HOST_PASSWORD=${{ secrets.PRODUCTION_EMAIL_HOST_PASSWORD }}
            DEFAULT_FROM_EMAIL=noreply@tulia.ai
            
            # Frontend
            FRONTEND_URL=${{ secrets.PRODUCTION_FRONTEND_URL }}
            
            # Subscription
            DEFAULT_TRIAL_DAYS=14
            
            # Payment Providers (Production Keys)
            STRIPE_SECRET_KEY=${{ secrets.PRODUCTION_STRIPE_SECRET_KEY }}
            STRIPE_PUBLISHABLE_KEY=${{ secrets.PRODUCTION_STRIPE_PUBLISHABLE_KEY }}
            STRIPE_WEBHOOK_SECRET=${{ secrets.PRODUCTION_STRIPE_WEBHOOK_SECRET }}
            
            PAYSTACK_SECRET_KEY=${{ secrets.PRODUCTION_PAYSTACK_SECRET_KEY }}
            PAYSTACK_PUBLIC_KEY=${{ secrets.PRODUCTION_PAYSTACK_PUBLIC_KEY }}
            
            PESAPAL_CONSUMER_KEY=${{ secrets.PRODUCTION_PESAPAL_CONSUMER_KEY }}
            PESAPAL_CONSUMER_SECRET=${{ secrets.PRODUCTION_PESAPAL_CONSUMER_SECRET }}
            PESAPAL_IPN_ID=${{ secrets.PRODUCTION_PESAPAL_IPN_ID }}
            PESAPAL_API_URL=https://pay.pesapal.com/v3
            
            MPESA_CONSUMER_KEY=${{ secrets.PRODUCTION_MPESA_CONSUMER_KEY }}
            MPESA_CONSUMER_SECRET=${{ secrets.PRODUCTION_MPESA_CONSUMER_SECRET }}
            MPESA_SHORTCODE=${{ secrets.PRODUCTION_MPESA_SHORTCODE }}
            MPESA_PASSKEY=${{ secrets.PRODUCTION_MPESA_PASSKEY }}
            MPESA_INITIATOR_NAME=${{ secrets.PRODUCTION_MPESA_INITIATOR_NAME }}
            MPESA_INITIATOR_PASSWORD=${{ secrets.PRODUCTION_MPESA_INITIATOR_PASSWORD }}
            MPESA_ENVIRONMENT=production
            MPESA_API_URL=https://api.safaricom.co.ke
            MPESA_B2C_SHORTCODE=${{ secrets.PRODUCTION_MPESA_B2C_SHORTCODE }}
            MPESA_B2C_SECURITY_CREDENTIAL=${{ secrets.PRODUCTION_MPESA_B2C_SECURITY_CREDENTIAL }}
            
            PESALINK_API_KEY=${{ secrets.PRODUCTION_PESALINK_API_KEY }}
            PESALINK_API_SECRET=${{ secrets.PRODUCTION_PESALINK_API_SECRET }}
            PESALINK_INSTITUTION_CODE=${{ secrets.PRODUCTION_PESALINK_INSTITUTION_CODE }}
            PESALINK_API_URL=${{ secrets.PRODUCTION_PESALINK_API_URL }}
            EOF
            
            # Stop existing containers gracefully
            docker-compose -f docker-compose.prod.yml down --timeout 30
            
            # Start new containers
            docker-compose -f docker-compose.prod.yml up -d
            
            # Run migrations
            docker-compose -f docker-compose.prod.yml exec -T web python manage.py migrate --noinput
            
            # Collect static files
            docker-compose -f docker-compose.prod.yml exec -T web python manage.py collectstatic --noinput
            
            # Health check with retries
            for i in {1..10}; do
              if curl -f http://localhost:8000/v1/health; then
                echo "Health check passed"
                exit 0
              fi
              echo "Health check attempt $i failed, retrying..."
              sleep 5
            done
            echo "Health check failed after 10 attempts"
            exit 1
      
      - name: Run smoke tests
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          port: ${{ secrets.PRODUCTION_PORT }}
          script: |
            cd /opt/tulia-ai
            
            # Test critical endpoints
            curl -f http://localhost:8000/v1/health || exit 1
            curl -f http://localhost:8000/schema/ || exit 1
      
      - name: Notify deployment status
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Production deployment ${{ job.status }} - Version: ${{ github.sha }}'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false
